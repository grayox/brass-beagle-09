<link rel="import" href="/bower_components/polymer/polymer-element.html">
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>

<link rel="import" href="geolocations-data.html">
<!--- ->
<link rel="import" href="/src/app-region/geo-code-data.html">
<!---->
<!-- region -->

<link rel="import" href="/src/app-view/app-item.html">

<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="/bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/src/app-view/app-item.html">
<link rel="import" href="/src/app-view/app-menu.html">

<dom-module id="geo-select">
  <template>
		<style include="paper-item-styles"></style>
		
		<geolocations-data geolocations-data="{{geoLocationsData}}"></geolocations-data>

    <app-item xhidden$="[[!georegion]]"
              type="output"
              icon="vaadin:flag"
              label="Geo location"
              xdata="[[georegion]]"
              >
    </app-item>
    <app-menu xmulti
              key="geo-select"
              xkey="region-counties-by-geo"
              xkey="[[key]]"
              xsubheader="[[regionName]]"
              subheader="Select your country"
              xitems="[[menuItems]]"
              xitems="[[items]]"
              items="[[geoListCountry]]"
              xselected="{{selectedMenuItem}}"
              selected-items="{{selectedItems}}"
              selected-label="{{selectedMenuItemLabel}}"
              >
    </app-menu>

  </template>

  <script>
		class GeoSelect extends Polymer.Element {
      static get is() { return 'geo-select'; }

      static get properties() {
        
        return {

					geoLocationsData: {
						type: Object,
						notify: true,
						//observer: '_geoCodeDataChanged', // For declarative binding only
					},

          geoListCountry: {
            type: Array,
            notify: true,
            computed: '_computeGeoListCountry(geoLocationsData)'
          },

					geoListRegion: {
            type: Array,
            notify: true,
            computed: '_computeGeoListRegion(geoLocationsData, geoCountry)'
          },

					// geoListRegion: {
          //   type: Array,
          //   notify: true,
          //   computed: '_computeGeoListRegion(geoListCountry, geoCountry)'
          // },

					geoListLocation: {
            type: Array,
            notify: true,
            computed: '_computeGeoListLocation(geoLocationsData, geoCountry, geoRegion)'
          },

					geoCountry: { // 'United regions'
						type: String,
						notify: true,
						// observer: '_geoCodeChanged',
						// value: () => null,
					},

					geoRegion: { // 'California'
						type: String,
						notify: true,
						// computed: '_computeGeoRegion(geoCode, geoCodeData)',
					},

					geoLocation: { // 'San Francisco'
						type: String,
						notify: true,
						// computed: '_computeGeoLocation(geoCode, geoCodeData)',
					},

					geoValid: {
						type: Boolean,
						notify: true,
						computed: '_computeGeoValid(geoCountry, geoRegion, geoLocation)',
					},

					geoObject: {
						type: Object,
						notify: true,
						computed: '_computeGeoObject(geoValid, geoCountry, geoRegion, geoLocation)',
					},

				};
			}
			
			constructor() {
				super();
			}
			
			ready() {
        super.ready();
        //window.addEventListener('user-action-select', (e) => this.onUserActionSelect(e));
				//this.getgeosData(); // use region element instead: <geo-code-data>
				//this.set('geoValid', !!this._computegeoValid(this.geocountry, this.georegion, this.geolocation));
		  }
			
			// connectedCallback() {
			// 	super.connectedCallback();
			// 	//console.log('connected!');
			// 	//this._init();
		  // }
			
			// _init(s) {
			// 	//const z = this.geoCode;
			// 	//console.log('s\n', s);
			// 	const country = this._computegeocountry(s);
			// 	//console.log('country\n', country);
			// 	const region = this._computegeoregion(s);
			// 	//console.log('region\n', region);
			// 	const location = this._computegeolocation(s);
			// 	//console.log('location\n', location);
			// 	this.set('geocountry', country);
			// 	this.set('georegion', region);
			// 	this.set('geolocation', location);
			// }
			
			// getgeosData() { // use region element instead: <geo-code-data>
			// 	const path = this.geoCodeDataAjaxPath;
			// 	// const path = 'src/custom-libraries/geo-code-data.json';
			// 	// http://stackoverflow.com/a/42763681/1640892
			// 	// https://github.com/PolymerElements/iron-ajax/blob/master/iron-ajax.html#L442
			// 	const ajax = document.createElement('iron-ajax');
			// 	ajax.method = 'get';
			// 	ajax.handleAs = 'json';
			// 	ajax.contentType = 'application/json';
			// 	ajax.url = path;
			// 	const _this = this;
			// 	ajax.addEventListener('response', function(e) {
			// 		// Use imperative method for updating as declarative binding is unavailable in a behavior
			// 		//response handler
			// 		//console.log('ajax', e);
			// 		//console.log('ajax', ajax.lastResponse);
			// 		//return ajax.lastResponse; // does not work
			// 		_this.geoCodeData = ajax.lastResponse;
			// 	});
			// 	ajax.generateRequest();
			// }

			// _geoCodeChanged(s) {
			//   //const geoCode = this.geoCode;
			//   //const geocountry = this.geocountry;
			//   const georegion = this.georegion;
			//   //console.log('geo-code\n', s);
			//   //console.log('geo-code-this\n', geoCode);
			//   //console.log('country\n', geocountry);
			//   //console.log('region\n', georegion);
			//   if(!georegion) {
			//     //console.log('initializing...', s);
			//   	 this._init(s);
			//   }
			// }

      _computeGeoListCountry(geoLocationsData) {
				//console.log('geo-locations-data', geoLocationsData);
        const ready1 = geoLocationsData;
        // const ready2 = geoCountry && geoLocationsData.geoCountry;
        // const ready3 = geoRegion && geoLocationsData.geoCountry.geoRegion;

        const ready = ready1;// && ready2 && ready3;
        if(!ready) return;

        const out = Object.keys(geoLocationsData);
				return out;
			}
			
			_computeGeoListRegion(geoLocationsData, geoCountry) {
				//console.log('geo-locations-data', geoLocationsData);
				//console.log('geo-country', geoCountry);
        const ready1 = geoLocationsData;
        const ready2 = geoCountry && geoLocationsData.geoCountry;
        // const ready3 = geoRegion && geoLocationsData.geoCountry.geoRegion;

        const ready = ready1 && ready2;// && ready3;
        if(!ready) return;

        const out = Object.keys(geoLocationsData.geoCountry);
				return out;
			}
			
			_computeGeoListLocation(geoLocationsData, geoCountry, geoRegion) {
				//console.log('geo-locations-data', geoLocationsData);
				//console.log('geo-country', geoCountry);
				//console.log('geo-region', geoRegion);
        const ready1 = geoLocationsData;
        const ready2 = geoCountry && geoLocationsData.geoCountry;
        const ready3 = geoRegion && geoLocationsData.geoCountry.geoRegion;

        const ready = ready1 && ready2 && ready3;
        if(!ready) return;

        const out = geoLocationsData.geoCountry.geoRegion;
				return out;
			}

			_computeGeoCountryRegionLocation(country, region, location) {
        // const ready = (country && region && location);
				// if(!ready) return;
        country = country ? country : null;
        region = region ? region : null;
        location = location ? location : null;
				return [ country , region, location, ].join(' > ');
			}

			_computeGeoValid(country, region, location) {
				//console.log('compute-geo-valid', country, region, location);
				const b1 = !!country && country.length;
				const b2 = !!region && region.length;
				const b3 = !!location && location.length;
        const out = !!(b1 && b2 && b3);
        return out;
			}
			
			// _geoCodeDataChanged(o) {
			// 	//console.log('geoCodeData', o);
    	// }
			
      // _show() {
			// 	console.log('geoValid\n', this.geoValid);
			// 	console.log('geo\n', this.geo);
			// 	console.log('geoCodeData\n', this.geoCodeData);
			// }

			_dispatchEvent(name, detail) {
				//this.fire('name', detail);
				// const n = 'save-app-item';
				const o = {
					bubbles: true,
					composed: true,
					detail: detail,
				};
				const d = new CustomEvent(name, o);
        this.dispatchEvent(d);
			}

      _computeGeoObject(geoValid, geoCountry, geoRegion, geoLocation) {
        const ready1 = geoValid;
        if (!ready1) return;

        const ready2 = (geoValid && geoCountry && geoRegion && geoLocation && geoCountryRegionLocation);
        if (!ready2) return;

        const out = {
          geoValid: geoValid,
          geoCountry: geoCountry,
          geoRegion: geoRegion,
          geoLocation: geoLocation,
          geoCountryRegionLocation: geoCountryRegionLocation,        
        }
        
        // console.log('geo-object\n', out);
        this._dispatchEvent('geo-valid', out);
        return out;
      }
			
		}
				
    window.customElements.define(GeoSelect.is, GeoSelect);
  </script>
</dom-module>
