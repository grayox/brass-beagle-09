<link rel="import" href="/bower_components/polymer/polymer-element.html">
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>

<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/src/app-main/app-methods.html">

<!-- state - ->
<link rel="import" href="/src/app-state/state-media.html">
<!---->
<link rel="import" href="/src/app-state/state-app-views.html">
<link rel="import" href="/src/app-state/state-user-remote.html">
<link rel="import" href="/src/app-state/state-user-local.html">
<link rel="import" href="/src/app-state/state-counties-by-state.html">

<dom-module id="state-app-settings">
  <template>
		<style></style>
		<app-localstorage-document xlog xsession-only key="app-settings" data="{{appSettings}}"></app-localstorage-document>

	  <!-- state - ->
    <state-media media-type="{{mediaType}}"></state-media>
    <!---->
    <state-app-views app-views="{{appViews}}"></state-app-views>
    <state-counties-by-state counties-by-state="{{countiesByState}}"></state-counties-by-state>
    <!--- ->
      <state-user-local user-local="{{userLocal}}"></state-user-local>
    <state-user-remote user-remote="{{userRemote}}"></state-user-remote>
    <!---->

    <app-methods id="methods" show-toast dispatch-event></app-methods>
		
  </template>

  <script>

    // The purpose of this element is to process app-views coming in as a json file
    // and fill out and return the entire app-settings object needed and used
    // by the page views to generate all the page elements.
    // TLDR: app-views.json => state-app-views => state-app-settings => my-app => dom-repeat(app-views)

    class StateAppSettings extends Polymer.Element {
      static get is() { return 'state-app-settings'; }

      static get properties() { return {
				appSettings: {
					type: Object,
					notify: true,
					// observer: '_appSettingsChanged',
          computed: '_computeAppSettings(appViews, userLocal)',
				},

				userLocal: {
					type: Object,
					notify: true,
					//observer: '_userLocalChanged',
          // computed: '_computeAppLocal(appViews, userLocal)'
				},
      }}
      
			constructor() {
				super();
			}
			
			ready() {
        super.ready();
        //window.addEventListener('user-action-select', (e) => this.onUserActionSelect(e));
		  }

			// save(data) {
				
			// 	//const timestamp = new Date().getTime();
			// 	const methods = this.$.methods;
				
			// 	// detail = {method: 'save'|'delete', entity: 'deal'|'bid'|'network', data: {new:'data'}}
			// 	const method = 'save'; // 'save'|'delete'
			// 	const entity = 'user-settings'; // 'zip'|'deal'|'bid'|'network'
			// 	//const data = data;
			// 	//const timestampedData = { ...data, ...{timestamp: timestamp} };
			// 	const detail = {
			// 		method: method,
			// 		entity: entity,
			// 		data: data,
			// 		//data: timestampedData,
			// 	};
				
			// 	methods.method(detail);
			// }
			
      // _userLocalChanged(newData, oldData) {
      //   console.log('user-local-old', oldData);
      //   console.log('user-local-new', newData);
      // }

      _computeAppSettings(appViews, userLocal) {
        // console.log('compute-app-settings');
        // console.log('app-views\n', appViews);
        // console.log('user-local\n', userLocal);
        const ready = appViews && userLocal;
        if(!ready) return;
        
        const views = appViews.views;
        const items = appViews.items;
        const out = views.reduce((c, v, i, a) => {
          // console.log('v\n', v);
          let viewItemsKeys = v['items-keys'] ? v['items-keys'] : []; // array
          // console.log('view-items-keys\n', viewItemsKeys);
          // assemble items from keys contained by view
          let viewItems = viewItemsKeys.reduce((ci, vi, ii, ai) => {
            let item = items[vi];
            // console.log('item\n', item);
            let userLocalSetting = userLocal[vi];
            if ( item && (item.data === 'settings' || item.data === 'Settings') ) {
              // substitute value from settings object
              item.data = userLocalSetting ? userLocalSetting : (item.value ? item.value : null);
            }
            return [ ...ci, item ];
          }, []);
          v.items = viewItems;
          return [ ...c, v ];
        }, []);

        console.log('app-settings\n', out);
        return out;
      }

      // saveAppSettings(data) {
      //   // console.log('data\n',data);
      //   // // console.log('user-remote\n', this.userRemote);
      //   // console.log('user-local\n', this.userLocal);
      //   // console.log('app-settings\n', this.appSettings);
      //   return;
      
      //   // common code below this line

			// 	const entity = 'user-settings';
				
			// 	const methods = this.$.methods;
			// 	// detail = {method: 'save'|'delete', entity: 'deal'|'bid'|'network', data: {new:'data'}}
			// 	const method = 'save'; // 'save'|'delete'
			// 	//const entity = 'user-switch'; // 'zip'|'deal'|'bid'|'network'
			// 	const detail = {
			// 		method: method,
			// 		entity: entity,
			// 		data: data,
			// 	};
			// 	// console.log('detail\n', detail);
			// 	methods.method(detail);
      // }

      // _appSettingsChanged(newData, oldData) {
      //   console.log('old-data\n', oldData);
      //   console.log('new-data\n', newData);
      // }
      
	  }

    window.customElements.define(StateAppSettings.is, StateAppSettings);
  </script>
</dom-module>
