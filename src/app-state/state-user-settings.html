<link rel="import" href="/bower_components/polymer/polymer-element.html">
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>

<!-- state -->
<link rel="import" href="state-app-data.html">
<link rel="import" href="state-app-settings.html">
<link rel="import" href="state-user-remote.html">
<link rel="import" href="/src/app-main/app-methods.html">
<!---->

<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="/bower_components/polymerfire/polymerfire.html">


<dom-module id="state-user-settings">
  <template>
    <style></style>
    <app-methods id="methods"></app-methods>
    <state-app-data app-data="{{appData}}"></state-app-data>
    <state-user-remote user-remote="{{userRemote}}"></state-user-remote>
    <!--- ->
    <state-app-settings xapp-settings="{{appSettings}}"></state-app-settings>
    <!---->

    <!---->
    <app-localstorage-document id="storage"
                               xlog
                               session-only
                               key="user-settings"
                               data="{{userSettings}}"
                               >
    </app-localstorage-document>
		<!--- ->
		<app-localstorage-document xlog xsession-only key="user-settings-home" data="{{userSettingsHome}}"> </app-localstorage-document>	
		<app-localstorage-document xlog xsession-only key="user-settings-mortgage" data="{{userSettingsMortgage}}"> </app-localstorage-document>	
		<app-localstorage-document xlog xsession-only key="user-settings-insurance" data="{{userSettingsInsurance}}"> </app-localstorage-document>	
		<app-localstorage-document xlog xsession-only key="user-settings-financial" data="{{userSettingsFinancial}}"> </app-localstorage-document>	
		<app-localstorage-document xlog xsession-only key="user-settings-text" data="{{userSettingsText}}"> </app-localstorage-document>	
		<app-localstorage-document xlog xsession-only key="user-settings-email" data="{{userSettingsEmail}}"> </app-localstorage-document>	
		<!--- ->
    <app-localstorage-document xlog session-only key="user-settings-zip" data="{{userSettingsZip}}"> </app-localstorage-document>	
    <app-localstorage-document xlog session-only key="user-settings-switch" data="{{userSettingsSwitch}}"> </app-localstorage-document>	
    <app-localstorage-document xlog session-only key="user-settings-input" data="{{userSettingsInput}}"> </app-localstorage-document>	
    <!---->
    
    <!--- ->
    <firebase-query id="query"
                    app-name="app"
                    name="app"
                    path="/users/[[userRemote.uid]]/settings"
                    xpath="/users/[[userUid]]/settings"
                    data="{{userSettings}}"
                    xdata="{{userLocal}}"
                    xlog
                    xlimit-to-last="1"
                    xlimit-to-first="1"
                    xorder-by-child="timestamp"
                    xorder-by-value="timestamp"
                    >
    </firebase-query>
    <!---->
    <firebase-document id="doc"
										   app-name="app"
										   name="app"
                       path="/users/[[userRemote.uid]]/settings"
                		   data="{{userSettings}}"
										   >
    </firebase-document>
	
	</template>

  <script>
    // state-user-settings fetches settings data from database (getter)
    // state-user-local distributes local user data throughout app (setter)
    class StateUserSettings extends Polymer.Element {
      static get is() { return 'state-user-settings'; }

      static get properties() { return {
				userSettings: {
					// initial value fetched by app-main.html > firebase-auth.user > path.
					type: Object,
					notify: true,
					observer: '_userSettingsChanged',
        },
        
				userRemote: {
					type: Object,
					// notify: true,
					observer: '_userRemoteChanged',
				},

				appData: {
					type: Object,
					// notify: true,
					observer: '_appDataChanged',
				},

				appSettings: {
					type: Object,
					// notify: true,
					// observer: '_appSettingsChanged',
				},
				
        // userSettingsHome: {
				// 	type: Boolean,
				// 	notify: true,
				// },
				// userSettingsMortgage: {
				// 	type: Boolean,
				// 	notify: true,
				// },
				// userSettingsInsurance: {
				// 	type: Boolean,
				// 	notify: true,
				// },
				// userSettingsFinancial: {
				// 	type: Boolean,
				// 	notify: true,
				// },
				// userSettingsText: {
				// 	type: String,
				// 	notify: true,
				// },
				// userSettingsEmail: {
				// 	type: String,
				// 	notify: true,
				// },
				// userSettingsZip: {
				// 	type: String,
				// 	notify: true,
				// },
				
        // userSettingsZip: {
        //   type: Object,
				// 	notify: true,
				// },
				// userSettingsSwitch: {
        //   type: Object,
				// 	notify: true,
				// },
				// userSettingsInput: {
        //   type: Object,
				// 	notify: true,
				// },
        
			}}
			
			constructor() {
				super();
			}
			
			ready() {
        super.ready();
        //window.addEventListener('user-action-select', (e) => this.onUserActionSelect(e));
        this.$.storage.destroy();
      }

      static get observers() {
        return [
          //'_updateDatabase(userRemote, appData, appSettings)',
        ]
      }

      _appDataChanged(newData, oldData) {
        this._resetOldData(newData, oldData, 'appData');
      }

      _appSettingsChanged(newData, oldData) {
        this._resetOldData(newData, oldData, 'appSettings');
      }
      
      _userRemoteChanged(newData, oldData) {
        this._resetOldData(newData, oldData, 'userRemote');
      }

      _updateDatabase(userRemote, appData, appSettings) {
        // abort if all variables not present
        const ready = appData && userRemote;
        if(!ready) return;
        
        console.log('app-data\n', appData);
        console.log('app-settings\n', appSettings);
        // // abort if any property of userRemote is a function
        // const o = Object.assign(userRemote, {});
        // let keys = Object.keys(o);
        // const abort = keys.reduce((c, v, i, a) => {
        //   if(typeof o[v] === 'function') {
        //     a.splice(1);  // break; // https://stackoverflow.com/a/47441371/1640892
        //     // console.log('Aborted save because user-remote contains funtion');
        //     return true;
        //   }
        //   return false;
        // }, false);

      }

      // _userSettingsChanged(newData, oldData) {
      //   // console.log('uid\n', this.userRemote.uid);
      //   //console.log('userSettings\n', r);
      //   console.log('oldData\n', oldData);
      //   console.log('newData\n', newData);
      // }

      _userSettingsChanged(newData, oldData) {
        this._resetOldData(newData, oldData, 'userSettings');
        this._handleNullValue(newData);
      }

      _resetOldData(newData, oldData, propertyName) {
        // console.log(propertyName, 'data-old\n', oldData);
        // console.log(propertyName, 'data-new\n', newData);
        // const userLoggedIn = this.userLoggedIn;
        // if(oldData && !newData && userLoggedIn) {
        if(oldData && !newData) {
          this.set(propertyName, oldData);
        }
        return;
      }

      _handleNullValue(o) {
        if(o !== {}) return;
        this._initializeSettings();
      }

      _initializeSettings() {

      }
			
    }

    window.customElements.define(StateUserSettings.is, StateUserSettings);
  </script>
</dom-module>
